#!/usr/bin/env node

'use strict';

const fs = require('fs');
const path = require('path');
const jsondiffpatch = require('jsondiffpatch');

const collect = require('..');

process.chdir(__dirname);

const runner = path.basename(__filename);

const list = fs.readdirSync(__dirname)
    .filter(fname => fname !== runner);

function filter(name) {
    if (process.argv.length <= 2) {
        return true;
    }

    const match = part => name.indexOf(part) >= 0;
    const negate = process.argv[2] === '!';
    const argv = process.argv.slice(negate ? 3 : 2);

    return negate ? !argv.some(match) : argv.some(match);
}

for (const name of list) {
    if (!filter(name)) {
        continue;
    }

    if (fs.lstatSync(name).isDirectory()) {
        continue;
    }

    console.log(`${name}...`);

    const code = fs.readFileSync(name, 'utf8');
    const {schemas: actual} = collect(name);
    const expected = eval(code.split('// ###')[1]);

    const delta = jsondiffpatch.diff(actual, expected);

    if (delta) {
        jsondiffpatch.console.log(delta);
    }
}
